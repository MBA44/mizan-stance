<!doctype html>
<html lang="{{ page.data.lang or metadata.language or 'fr' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{{ title or metadata.title }}</title>
    <meta name="description" content="{{ description or metadata.description }}">

    {# Feed #}
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="{{ metadata.title }}">

    {# Canonical (domaine unique, sans www) #}
    <link rel="canonical" href="https://mizan-stance.org{{ page.url }}">

    {# =========================
       HREFLANG (FR/EN) — ROBUSTE
       - Site non-miroir : URLs FR/EN peuvent différer
       - Source de vérité : front-matter via page.data.lang + page.data.translation
       - x-default : toujours la page seuil "/"
       ========================= #}

    {% set site = "https://mizan-stance.org" %}
    {% set p = page.url %}
    {% set currentLang = page.data.lang or metadata.language or "fr" %}
    {% set translationUrl = page.data.translation %}

    {# x-default partout (utile à Google) #}
    <link rel="alternate" hreflang="x-default" href="{{ site }}/" />

    {# Homepage : propose les deux entrées #}
    {% if p == "/" %}
      <link rel="alternate" hreflang="fr" href="{{ site }}/fr/" />
      <link rel="alternate" hreflang="en" href="{{ site }}/en/" />
      <link rel="alternate" hreflang="x-default" href="{{ site }}/" />

    {% else %}

      {# Toujours déclarer la page courante dans sa langue #}
      <link rel="alternate" hreflang="{{ currentLang }}" href="{{ site }}{{ p }}" />

      {# Déclarer la traduction seulement si elle est explicitement définie #}
      {% if translationUrl %}
        {% set otherLang = "en" if currentLang == "fr" else "fr" %}
        <link rel="alternate" hreflang="{{ otherLang }}" href="{{ site }}{{ translationUrl }}" />
      {% endif %}

    {% endif %}

    {# Styles #}
    <style>{% include "css/index.css" %}</style>
    <style>{% getBundle "css" %}</style>

    {# Scripts #}
    <script type="module">{% include "node_modules/@zachleat/heading-anchors/heading-anchors.js" %}</script>
  </head>

  <body>
    <a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

    <header>
      <div class="topbar">
        <a href="/" class="home-link">{{ metadata.title }}</a>

        {# =========================
           Language switch (navigation)
           - Utilise page.data.translation si présent
           - Sinon fallback vers /fr/ ou /en/
           ========================= #}

        {% set navLang = page.data.lang or metadata.language or "fr" %}
        {% set otherNavLang = "en" if navLang == "fr" else "fr" %}
        {% set otherUrl = page.data.translation or ("/" + otherNavLang + "/") %}

        <nav aria-label="Language switch" class="lang-switch">
          {% if navLang == "fr" %}
            <strong>FR</strong>
            <span> · </span>
            <a href="{{ otherUrl }}" lang="en">EN</a>
          {% else %}
            <a href="{{ otherUrl }}" lang="fr">FR</a>
            <span> · </span>
            <strong>EN</strong>
          {% endif %}
        </nav>
      </div>

      {# Navigation principale (eleventy-navigation) #}
      <nav>
        <h2 class="visually-hidden">Top level navigation menu</h2>
        <ul class="nav">
          {%- for entry in collections.all | eleventyNavigation %}
            <li class="nav-item">
              <a href="{{ entry.url }}"{% if entry.url == page.url %} aria-current="page"{% endif %}>
                {{ entry.title }}
              </a>
            </li>
          {%- endfor %}
        </ul>
      </nav>
    </header>

    <main id="main">
      <heading-anchors>
        {{ content | safe }}
      </heading-anchors>
    </main>

    <footer>
      <p>
        <em>Built with <a href="https://www.11ty.dev/">{{ eleventy.generator }}</a></em>
      </p>
    </footer>

    <!-- This page `{{ page.url }}` was built on {% currentBuildDate %} -->
    <script type="module" src="{% getBundleFileUrl "js" %}"></script>
  </body>
</html>